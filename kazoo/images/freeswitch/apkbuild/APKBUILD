# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
# Contributor: Michael Mason <ms13sp@gmail.com>
# Contributor: Cameron Banta <cbanta@gmail.com>
#
#
pkgname=freeswitch
pkgver=${FS_VER:-1.9.20}
pkgrel=0
pkgdesc="A communications platform written in C from the ground up"
url="http://www.freeswitch.org"
arch="all"
license="GPL"

_fs_hash=${FS_HASH:-f3841b119925b5b82acca67cfa9bd3b47a19270d402ab9b4c1754117bc1ac331dc6d2e8ec386f3b3ed1b95ef9c6c4c6d7b438476dd378ab9b5384bbb4a42625f}

_fs_source_filename=${FS_SOURCE_FILENAME:-${pkgname}-${pkgver}.tar.xz}
_fs_source_url="${FS_SOURCE_URL:-https://files.freeswitch.org/releases/freeswitch/${_fs_source_filename}}"

builddir="$srcdir/$pkgname-$pkgver"

makedepends="
    bash
    bsd-compat-headers
    coreutils
    curl-dev
    db-dev
    flac-dev
    flite-dev
    gdbm-dev
    gnutls-dev
    ilbc-dev
    lame-dev
    ldns-dev
    libedit-dev
    libexecinfo-dev
    libjpeg-turbo-dev
    libogg-dev
    libpri-dev
    libressl-dev
    libshout-dev
    libsndfile-dev
    libvorbis-dev
    linux-headers
    lua5.2-dev
    mpg123-dev
    ncurses-dev
    net-snmp-dev
    opus-dev
    pcre-dev
    perl-dev
    portaudio-dev
    postgresql-dev
    sngtc_client-dev
    speex-dev
    speexdsp-dev
    sqlite-dev
    unixodbc-dev
    util-linux-dev
    xmlrpc-c-dev
    yasm
    zlib-dev
    tiff-dev
    php7-dev
    erlang-dev
    ffmpeg-dev
    autoconf automake libtool
    "
install="$pkgname.pre-install $pkgname.pre-upgrade"

FREESWITCH_USER=freeswitch
FREESWITCH_GROUP=freeswitch
pkgusers="$FREESWITCH_USER"
pkggroups="$FREESWITCH_GROUP"

subpackages="$pkgname-dbg $pkgname-dev $pkgname-flite $pkgname-timezones::noarch
    $pkgname-sample-config:conf:noarch $pkgname-freetdm $pkgname-sangoma
    $pkgname-snmp $pkgname-pgsql $pkgname-perl"

source="${_fs_source_url}
    0001-FS-10774-switch_pgsql-Fix-build-for-PostgreSQL-libpq.patch
    0001-mod-loopback-attxfer.patch
    0001-mod_spandsp-max-tones.patch
    0001-sofia-sip-byte-order.patch
    0001-switch-console-crash.patch
    0001-switch-core-io.patch
    0002-FS-verto-bswap_64.patch
    0002-sofia-glue-gateway-crash.patch
    001-switch-buffer.patch
    freeswitch.confd
    freeswitch.initd
    getlib.patch
    modules.conf
    "

prepare() {
    default_prepare
    update_config_sub
}

build() {
    cd "$builddir"

    cp -f "$srcdir/modules.conf" modules.conf

    CFLAGS="-Wno-unused-but-set-variable" ./configure \
      --build=$CBUILD \
      --host=$CHOST \
      --prefix=/usr \
      --enable-fhs \
      --localstatedir=/var \
      --sysconfdir=/etc \
      --with-scriptdir=/etc/freeswitch/scripts \
      --mandir=/usr/share/man \
      --infodir=/usr/share/info \
      --with-devrandom=/dev/urandom \
      --with-libpri \
      --disable-debug \
      --enable-core-pgsql-support \
      --enable-system-lua \
      --enable-system-xmlrpc-c

    # build freetdm with -lexecinfo
    make -C libs/freetdm LIBS="-lexecinfo"
    # first build libfreeswitch (in parallel)
    make src/include/switch_version.h src/include/switch_swigable_cpp.h
    make libfreeswitch.la
    # finally we build the rest
    make -j1 all

}

package(){
    cd "$builddir"
    make -j1 DESTDIR="$pkgdir" install samples-conf samples-htdocs

    install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
    install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
    chown -R $FREESWITCH_USER:$FREESWITCH_GROUP "$pkgdir"/var/*/freeswitch

    cp /usr/bin/epmd "$pkgdir"/usr/bin
}


_mv_mod() {
    local moddir=usr/lib/freeswitch/mod i=
    mkdir -p "$subpkgdir"/$moddir
    for i in $@; do
        mv "$pkgdir"/$moddir/$i.so "$subpkgdir"/$moddir/
    done
}


flite() {
    pkgdesc="Freeswitch Text To Speech Module"
    install=
    _mv_mod mod_flite
##
## The mod_say_xx modules can be used with out flite (for numbers, etc using
## sound files). So they shouldn't be in the flite package -cB
##
# _mv_mod mod_say_de mod_say_en mod_say_es mod_say_fr \
#     mod_say_it mod_say_nl mod_say_zh mod_say_hu mod_say_ru \
#     mod_say_th mod_say_he
}

freetdm() {
    pkgdesc="Freeswitch FreeTDM Module"
    install=
    _mv_mod mod_freetdm ftmod_analog ftmod_analog_em ftmod_libpri ftmod_skel ftmod_zt
    mv "$pkgdir"/usr/lib/libfreetdm.so* "$subpkgdir"/usr/lib/
}

sangoma() {
    pkgdesc="Freeswitch Sangoma Media Transcode Codec Module"
    install=
    _mv_mod mod_sangoma_codec
}

timezones() {
    pkgdesc="Freeswitch timezone configuration"
    install=
    replaces="freeswitch-sample-config"
    mkdir -p "$subpkgdir"/etc/freeswitch/autoload_configs
    mv "$pkgdir"/etc/freeswitch/autoload_configs/timezones.conf.xml \
        "$subpkgdir"/etc/freeswitch/autoload_configs
}

snmp() {
    pkgdesc="Freeswitch SNMP module"
    install=
    _mv_mod mod_snmp
}

pgsql() {
    pkgdesc="Freeswitch PostgreSQL Module"
    install=
    _mv_mod mod_cdr_pg_csv
}

perl() {
    pkgdesc="Freeswitch Perl module"
    install=
    _mv_mod mod_perl
}

conf() {
    pkgdesc="Freeswitch sample configureation"
    depends="freeswitch-timezones"
    install=
    mkdir -p "$subpkgdir"/etc/freeswitch
    # move all configs except freeswitch.xml
    for i in "$pkgdir"/etc/freeswitch/*; do
        [ "$i" = "$pkgdir"/etc/freeswitch/freeswitch.xml ] && continue
        mv "$i" "$subpkgdir"/etc/freeswitch/
    done
    mkdir -p "$pkgdir"/etc/freeswitch/scripts
}

sha512sums="${_fs_hash}  ${_fs_source_filename}
db61d9a253105f7a1ef5f5c218b367a833f62a2e85e364e3971acc79f68037b0270c5b2f3e0909643278b6b93104ac8e59b323470aeef5f519c33b0289c0fcf3  0001-FS-10774-switch_pgsql-Fix-build-for-PostgreSQL-libpq.patch
2e8b449d3011455299058659773d96d8dd0fd05fbab7d57136404c6a46e62989b71c01b2aaec16a33d4a365a1c77eafb5ffc0b9c1c56043f1aced95cefeeaa07  0001-mod-loopback-attxfer.patch
2a81bb2ba0a76b1e5b622d7b95827ad47cb318d111ea136e8fd245c2f6a86949d220a96bc33dbe7539b04e73c68ec512b88c6ee5d561094f77d0902980210408  0001-mod_spandsp-max-tones.patch
8a7ca31cc80524b02edc83af891a32af64dd7834ac14b1389112f2ce7fe06fe602d24509a299898f25e807dd0b88544aecb990bf4bd37ee1c7023ae58dacd28a  0001-sofia-sip-byte-order.patch
89dd3a6b01290d7d71af4b32ba1cc2003e3a73fb2df1f7153a15d0a57e9d0fa316b017f7cc979980b39306da8b34e0dc494f8a392ba4b4194280a7a3d9230f8c  0001-switch-console-crash.patch
5f93150e1acd632df98bc3bed5613fb1e45180ae4096dcfee5c060da213c8355339260eaf5758cd77c785f6d84cf0661650a872ec574b586ab19803d4f6955f8  0002-FS-verto-bswap_64.patch
1217a756d9c94fff9d01426d7057c7f2aa2be63fd5965d97feca79bbde7d786b0a23be0d5a3ab957bc1b27154a72fa3ff024bf57091ef267a553c193c625cec3  0002-sofia-glue-gateway-crash.patch
f043341ce03a16f0c39631b66666b210283c08f462cb03db327d10de38c285985ef5f8505ccad941946b030100ad80c8595d0d216975a5029a31dc68f9dee9d3  001-rtmp-libressl.patch
d596c529cfa7626374143f350f7357340c5086e014f9b4f895023a6feca472157fe8e5c0ef2f501933d2a7c1b656f20b3a68e14d1f815430128f925736914f82  001-srtp-libressl.patch
1f1db8be11bedf50a5cb1ac3e36dc13fc10b11f43aa444b1c9ee72d1e7591db0228dbd65d5f33a70f71c52c0332e3e3867888dcde0f3098439d3fab29bc2997a  001-ssl-libressl.patch
59d3eba8f789d31372a78b94875386316a2fabf6989dca2da82f53f9981b8ff559674916b89ef66d41c35bffad5a055d9621de1ae8a90276c52a4811f76b1974  001-switch-buffer.patch
a585f6411185a26206137a1ad97a06fd6c73e80c5439e9be45eabfa70e7a83120169ba882971fcd328436c8e0242cbd664170b80754ea2846021689baf1f1595  freeswitch.confd
643d0a2e43f5d3bf3b99fcb6f6422302cb4b74a95eccf844eafb100b15aa9856b4ff41f112d6637255c2e9e2bec9fedc9a9215dfff214dfb83b52eae16b71dca  freeswitch.initd
4ceb48f64d2bc26a02cc0846276506241bfd30c156422b0a1d608fd172c099feb5c121a763652e9a45046dcdd0ba0eb71eab240e0c6ce2ad63ff781719e135a4  getlib.patch
81afddd92c100d266d5ad1ff8b919a3a91fcca714b9d10a466b98bdcffd359d8c21c5a1c81df70811f44018216743af554b22f5e327a5743c046c7b79fb65767  modules.conf"
